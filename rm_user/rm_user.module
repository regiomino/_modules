<?php

function rm_user_init() {
    global $base_url;
    if(drupal_is_front_page() && strpos($_SERVER['HTTP_REFERER'],$base_url) === FALSE && empty($_SESSION['messages'])) {
        global $user;
        if($user->uid > 0) {
            $userobject = rm_user_address_complete($user->uid);
            if($userobject) {
                if(isset($userobject->field_first_name[LANGUAGE_NONE][0]['value']) && !empty($userobject->field_first_name[LANGUAGE_NONE][0]['value']) && isset($userobject->field_last_name[LANGUAGE_NONE][0]['value']) && !empty($userobject->field_last_name[LANGUAGE_NONE][0]['value'])) {
                    $name = $userobject->field_first_name[LANGUAGE_NONE][0]['value'] . ' ' . $userobject->field_last_name[LANGUAGE_NONE][0]['value'];
                }
                else {
                    $userobject = $account->mail;
                }
                drupal_goto('lieferanten/' . $userobject->field_address[LANGUAGE_NONE][0]['locality'] . '/' . $userobject->field_address[LANGUAGE_NONE][0]['postal_code'] . '/' . $userobject->field_address[LANGUAGE_NONE][0]['thoroughfare']);
                drupal_set_message(t('Welcome back @username. Here are all the available vendors for your last location in @street, @zip @city. If you would like to enter a different address, please <a href="@url">click here</a>.', array('@street' => $userobject->field_address[LANGUAGE_NONE][0]['thoroughfare'], '@username' => $name, '@zip' => $userobject->field_address[LANGUAGE_NONE][0]['postal_code'], '@city' => $userobject->field_address[LANGUAGE_NONE][0]['locality'], '@url' => url())));
            }
        }
    }
}

function rm_user_get_navbar() {
    global $user;
    $html = '';
    if($user->uid > 0) {
        $account = user_load($user->uid);
        if($user->uid == 1) $html .= l(t('<span class="@class"></span> @linktitle', array('@class' => 'glyphicon glyphicon-wrench', '@linktitle' => t('Admin'))), 'admin', array('query' => drupal_get_destination(), 'html' => TRUE, 'attributes' => array('class' => array('btn', 'btn-success')))) . ' ';
        if(in_array('salesguy', $account->roles)) $html .= l(t('<span class="@class"></span> @linktitle', array('@class' => 'glyphicon glyphicon-briefcase', '@linktitle' => format_username($user))), 'manage/sales', array('query' => drupal_get_destination(), 'html' => TRUE, 'attributes' => array('class' => array('btn', 'btn-info')))) . ' ';
        $html .= l(t('<span class="@class"></span> @linktitle', array('@class' => 'glyphicon glyphicon-user', '@linktitle' => t('Log out'))), 'user/logout', array('query' => drupal_get_destination(), 'html' => TRUE, 'attributes' => array('class' => array('btn', 'btn-warning'))));
    }
    else {
        $html .= l(t('<span class="@class"></span> @linktitle', array('@class' => 'glyphicon glyphicon-user', '@linktitle' => t('Log in'))), 'user/register', array('query' => drupal_get_destination(), 'html' => TRUE, 'attributes' => array('class' => array('btn', 'btn-success'))));
    }
    return $html;
}

/**
* Checks if a user has the admin role
*
* @param $uid
*   The user id of the user to be checked. If left at null, the current user is detected
*
* @return boolean
*/
function rm_user_is_admin($uid = NULL) {
    if(is_null($uid)) {
        global $user;
        $uid = $user->uid;
    }
    $account = user_load($uid);
    return (in_array('admin', $account->roles)) ? TRUE : FALSE;
}

/**
* Returns all users for a given role
*
* @param $role
*   The role that all users are supposed to have
*
* @return array
*/
function rm_user_get_users_by_role($role) {
    $static = &drupal_static(__FUNCTION__);
    if(!isset($static[$role])) {
        $query = db_select('users', 'u');
        $query->join('users_roles', 'ur', 'u.uid = ur.uid');
        $query->join('role', 'r', 'ur.rid = r.rid');
        $query->fields('u',array('uid'));
        $query->condition('r.name', $role, '=');
        $result = $query->execute();
        $uids = array();
        while($record = $result->fetchAssoc()) {
            $uids[] = $record['uid'];
        }
        $static[$role] = $uids;
    }
    return $static[$role];
}

/**
* Implements hook_menu().
*/
function rm_user_menu() {
	$items = array();

  $items['manage/myaccount'] = array(
    'title' => 'Transactions',
    'page callback' => 'drupal_get_form',
		'page arguments' => array('rm_user_myaccount', 'transactions_purchase'),
		'access arguments' => array('authenticated user'),
    'file' => 'rm_user.inc',
    'file path' => drupal_get_path('module', 'rm_user'),
    'type' => MENU_NORMAL_ITEM,
  );
	$items['manage/myaccount/purchase'] = array(
    'title' => 'Purchase Transactions',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );
  $items['manage/myaccount/sales'] = array(
    'title' => 'Sales Transactions',
    'page callback' => 'drupal_get_form',
		'page arguments' => array('rm_user_myaccount', 'transactions_sales'),
		'access arguments' => array('authenticated user'),
    'file' => 'rm_user.inc',
    'file path' => drupal_get_path('module', 'rm_user'),
    'type' => MENU_LOCAL_TASK,
  );
    $items['user/%/shadow/%'] = array(
        'page callback' => 'rm_user_shadow',
        'page arguments' => array(1,3),
        'access callback' => 'rm_user_may_be_shadowed',
        'access arguments' => array(1,3),
	);
    $items['user/%/disable/%'] = array(
        'page callback' => 'rm_user_disable',
        'page arguments' => array(1,3),
        'access callback' => 'rm_user_is_admin',
	);
    $items['user/%/enable/%'] = array(
        'page callback' => 'rm_user_enable',
        'page arguments' => array(1,3),
        'access callback' => 'rm_user_is_admin',
	);
	return $items;
}

function rm_user_may_be_shadowed($cuid, $tuid) {
    global $user;
    if($tuid == 1) return FALSE;
    if(rm_user_is_admin()) return TRUE;
    if(rm_sales_user_is_salesguy()) {
        $query = new EntityFieldQuery();
        $tmp = $query
            ->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', array('seller_profile', 'customer_profile'))
            ->fieldCondition('field_salesguy', 'target_id', $user->uid)
            ->execute();
        $alluids = array();
        if(isset($tmp['node'])) {
            $allprofiles = entity_load('node', array_keys($tmp['node']));
            if(isset($allprofiles)) {
                foreach($allprofiles as $nid => $profile) {
                    $alluids[$profile->uid] = TRUE;
                }
            }
        }
        if(in_array($tuid, array_keys($alluids))) return TRUE;
    }
}

function rm_user_disable($cuid, $tuid) {
	if (rm_user_is_admin() && $tuid != 1) {
		$tuserobject = user_load($tuid);
        $tuserobject->status = 0;
        user_save($tuserobject);
        drupal_goto();
    }
	else {
		drupal_access_denied();
	}
}

function rm_user_enable($cuid, $tuid) {
	if (rm_user_is_admin() && $tuid != 1) {
		$tuserobject = user_load($tuid);
        $tuserobject->status = 1;
        user_save($tuserobject);
        drupal_goto();
    }
	else {
		drupal_access_denied();
	}
}

function rm_user_shadow($cuid, $tuid) {
    global $user;
    $tuserobject = user_load($tuid);
    $cuserobject = user_load($user->uid);
    $user = user_load($tuid);
    $login_array = array ('name' => $user->name);
    drupal_set_message(t('You are now logged in as @username', array('@username' => format_username($user))));
    user_login_finalize($login_array);
    drupal_goto();
}

/**
 * Implements hook_username_alter.
 * @param $name
 * @param $account
 */
function rm_sales_username_alter(&$name, $account) {
	if($account->uid > 0) {
        $account = user_load($account->uid);
        if(isset($account->field_first_name[LANGUAGE_NONE][0]['value']) && !empty($account->field_first_name[LANGUAGE_NONE][0]['value']) && isset($account->field_last_name[LANGUAGE_NONE][0]['value']) && !empty($account->field_last_name[LANGUAGE_NONE][0]['value'])) {
            $name = $account->field_first_name[LANGUAGE_NONE][0]['value'] . ' ' . $account->field_last_name[LANGUAGE_NONE][0]['value'];
        }
        else {
            $name = $account->mail;
        }
    }
}

/**
 * Function to easily store an entry in the users activity log
 *
 * @param $message
 *		The message that describes the action the user took
 *
 * @param $entityid
 *		The id of the entity that the users action is related to
 *
 * @param entitytype
 *		The entity type that the users action is related to
 *
 * @param uid
 *		The uid of the user that took the action. If left at null this is set to the current users uid.
 */
function rm_user_activity($message, $entityid = NULL, $entitytype = NULL, $uid = NULL) {
	if(is_null($uid)) {
		global $user;
		$uid = $user->uid;
	}
	
	$new_node = rm_api_create_new_node('activity_log', substr(strip_tags($message), 0, 128), 'de', $uid, 1, 0, 0, 0);
	
	$new_node->body[LANGUAGE_NONE][0]['value'] = $message;
	if(!is_null($entityid)) $new_node->field_entityid[LANGUAGE_NONE][0]['value'] = $entityid;
	if(!is_null($entitytype)) $new_node->field_entitytype[LANGUAGE_NONE][0]['value'] = $entitytype;
	
	node_save($new_node);
}

/**
 * Function to easily store a transaction in the userobject
 *
 * @param $amount
 *		The amount of the transaction
 *
 * @param $reason
 *		The reason for the transaction
 *
 * @param $node_type
 *		The name of the node type (e.g. 'transactions_purchase' for purchase transactions
 *		or 'transactions_sales' for selling transactions
 *
 * @param $entityid
 *		The id of the entity that the transaction is related to
 *
 * @param entitytype
 *		The entity type that the transaction is related to
 *
 * @param uid
 *		The uid of the user that receives the transaction. If left at null this is set to the current users uid.
 */
function rm_user_transaction($amount, $reason, $node_type, $entityid = NULL, $entitytype = NULL, $uid = NULL) {

	if(is_null($uid)) {
		global $user;
		$uid = $user->uid;
	}
	
	$query = new EntityFieldQuery();
	$tmp = $query
		->entityCondition('entity_type', 'node')
		->entityCondition('bundle', $node_type)
		->propertyCondition('status', 1)
		->propertyOrderBy('created', 'DESC')
		->execute();
	if(isset($tmp['node'])) {
		$allnids = array_keys($tmp['node']);
		$txn_node = node_load($allnids[0]);
	}
	if(isset($txn_node)) {
		$balance = $amount + $txn_node->field_balance[LANGUAGE_NONE][0]['value'];
	}
	else {
		$balance = $amount;
	}
	
	$new_node = rm_api_create_new_node($node_type, substr(strip_tags($reason), 0, 128), 'de', $uid, 1, 0, 0, 0);
	
	$new_node->body[LANGUAGE_NONE][0]['value'] = $reason;
	$new_node->field_amount[LANGUAGE_NONE][0]['value'] = $amount;
	$new_node->field_balance[LANGUAGE_NONE][0]['value'] = $balance;
	if(!is_null($entityid)) $new_node->field_entityid[LANGUAGE_NONE][0]['value'] = $entityid;
	if(!is_null($entitytype)) $new_node->field_entitytype[LANGUAGE_NONE][0]['value'] = $entitytype;
	
	node_save($new_node);
}

function rm_user_mail($key, &$message, $params) {
	global $base_url;
	global $base_path;
	switch($key) {
		//switching on $key lets you create variations of the email based on the $key parameter
		case 'profile_published_user_registered':
			$message['subject'] = 'Ihr Profil regiomino.de';

			$message['body'][] = '<p>Hi,</p><p>Ihr Profil auf www.regiomino.de wurde freigeschaltet und es wurde ein neues Benutzerkonto für Sie angelegt. Sie können sich jetzt mit folgenden Daten auf www.regiomino.de anmelden.</p><p>E-Mail: ' . $params['account']->mail . '<br />Passwort: ' . $params['password'] . '</p><p>Viele Grüße,<br />Ihr Regiomino-Team</p>';
			
		break;
	}
}

function rm_user_user_insert(&$edit, $account, $category) {
    if( !empty($account->mail) &&
        !empty($account->field_first_name[LANGUAGE_NONE][0]['value']) &&
        !empty($account->field_last_name[LANGUAGE_NONE][0]['value']) &&
        !empty($account->field_gender[LANGUAGE_NONE][0]['value'])
    ) {
        $result = rm_api_mailchimp_subscribe(
            $account->mail,
            array(
                'FNAME' => $account->field_first_name[LANGUAGE_NONE][0]['value'],
                'LNAME' => $account->field_last_name[LANGUAGE_NONE][0]['value'],
                'SALUTATION' => ($account->field_gender[LANGUAGE_NONE][0]['value'] == 'f') ? 'Frau' : 'Herr',
                'ROLES' => 'authenticated user'
            )
        );
    }
}

function rm_user_address_complete($uid) {
    $userobject = user_load($uid);
    if( !empty($userobject->field_address[LANGUAGE_NONE][0]['thoroughfare']) &&
        !empty($userobject->field_address[LANGUAGE_NONE][0]['postal_code']) &&
        !empty($userobject->field_address[LANGUAGE_NONE][0]['locality'])
    ) {
        return $userobject;
    }
    else {
        return FALSE;
    }
}